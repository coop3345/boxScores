<!DOCTYPE html>
<meta charset='utf-8'>
<style>
  body {
    background-color: rgb(225, 225, 225);
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
  }
  
  #dropdowns { margin-block-end: 8px}
  #week, #game, #svg {display: inline-block; *display: inline; vertical-align: top; font-size: 12px;}

  table { 
    width: 100%; 
    border-collapse: collapse; 
  }
  /* Zebra striping */
  tr:nth-of-type(even) { 
    background: rgb(250, 250, 250); 
  }
  th { 
    background: #fff; 
    color: black; 
    font-weight: bold; 
    cursor: s-resize;
    background-repeat: no-repeat;
        background-position: 3% center;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd
  }
  td, th { 
    padding: 6px; 
    text-align: right; 
  }
  td {
    border-top: 1px solid #eee;
  }

  tr:hover {
    background-color: rgb(215, 215, 215)
  }

  th:first-child,td:first-child {
    text-align: left;
  }

  th.des:after {
    content: '\21E9';
  }
    
  th.aes:after {
    content: '\21E7';
  }

  .clearfix:after {
    /* margin-block-end: 8px; */
    display: flex;
    margin-bottom: 8px;
    visibility: hidden;
    display: block;
    font-size: 0;
    content: ' ';
    clear: both;
    height: 0;
    }
  * html .clearfix             { zoom: 1; } /* IE6 */
  *:first-child+html .clearfix { zoom: 1; } /* IE7 */

  .ticks {
    font: 10px sans-serif;
  }

  .track,
  .track-inset,
  .track-overlay {
    stroke-linecap: round;
  }

  .track {
    stroke: #000;
    stroke-opacity: 0.3;
    stroke-width: 10px;
  }

  .track-inset {
    stroke: rgb(22, 163, 69);
    stroke-width: 8px;
  }

  .track-overlay {
    pointer-events: stroke;
    stroke-width: 50px;
    stroke: transparent;
    cursor: crosshair;
  }

  .handle {
    fill: rgba(126, 79, 8, 0.87);
    stroke: #000;
    stroke-opacity: 0.5;
    stroke-width: 1.25px;
  }
</style>

<body>
  <div id='dropdowns'>
    <select id='week'></select>
    <select id='game'></select>
    <div id='svg'></div>
  </div>
  <div id='gameDiv'></div>
  <!--svg width='1340' height='250'></svg -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src='https://d3js.org/d3.v4.min.js'></script>
  <script>
  // Get all the data. Start working with filters
  d3.csv('testpbp.csv', function(error, data){
    data.forEach(function(d){
      // GameID = +d.GameID;
      // Drive = +d.Drive;
      // qtr = +d.qtr;
      // down = +d.down;
      // clock = +d.clock;
      // TimeSecs = +d.TimeSecs;
      // yrdln = +d.yrdln;
      // yrdline100 = +d.yrdline100;
      // ydstogo = +d.ydstogo;
      // ydsnet = +d.ydsnet;
      // GoalToGo = +d.GoalToGo;
      // FirstDown = +d.FirstDown;
      // posteam = +d.posteam;
      // DefensiveTeam = +d.DefensiveTeam;
      // playdesc = +d.playdesc;
      // PlayAttempted = +d.PlayAttempted;
      // YardsGained = +d.YardsGained;
      // Touchdown = +d.Touchdown;
      // PlayType = +d.PlayType;
      // Passer = +d.Passer;
      // Passer_ID = +d.Passer_ID;
      // PassAttempt = +d.PassAttempt;
      // PassOutcome = +d.PassOutcome;
      // PassLength = +d.PassLength;
      // AirYards = +d.AirYards;
      // YardsAfterCatch = +d.YardsAfterCatch;
      // QBHit = +d.QBHit;
      // PassLocation = +d.PassLocation;
      // InterceptionThrown = +d.InterceptionThrown;
      // Rusher = +d.Rusher;
      // Rusher_ID = +d.Rusher_ID;
      // RushAttempt = +d.RushAttempt;
      // RunLocation = +d.RunLocation;
      // RunGap = +d.RunGap;
      // Receiver = +d.Receiver;
      // Receiver_ID = +d.Receiver_ID;
      // Reception = +d.Reception;
      // ReturnResult = +d.ReturnResult;
      // Returner = +d.Returner;
      // FieldGoalResult = +d.FieldGoalResult;
      // FieldGoalDistance = +d.FieldGoalDistance;
      // Fumble = +d.Fumble;
      // RecFumbTeam = +d.RecFumbTeam;
      // RecFumbPlayer = +d.RecFumbPlayer;
      // Sack = +d.Sack;
      // ChallengeReplay = +d.ChallengeReplay;
      // ChalReplayResult = +d.ChalReplayResult;
      // AcceptedPenalty = +d.AcceptedPenalty;
      // PenalizedTeam = +d.PenalizedTeam;
      // PenaltyType = +d.PenaltyType;
      // PenalizedPlayer = +d.PenalizedPlayer;
      // PenaltyYards = +d.PenaltyYards;
      // HomeTeam = +d.HomeTeam;
      // AwayTeam = +d.AwayTeam;
      // Home_WP_post = +d.Home_WP_post;
      // Away_WP_post = +d.Away_WP_post;
      // Season = +d.Season;
      // Kicker = +d.Kicker;
      // Kicker_ID = +d.Kicker_ID;
      // WeekNumber = +d.WeekNumber;
    });
    //console.log(data);
    
    var margin = {padLeft: 190, padTop: 0},
        width = $(window).width() - margin.padLeft,
        height,
        sx,
        sy = 9.5,
        startSlider = true,
        gameFiltered,
        secondSelection,
        myClock = 'Q4 00:00',
        weekSelection = 'Week',
        gameSelection = 'Games',
        games = ['Games'],
        gameIDs = [],
        formatInt = d3.format('.0f'),
        formatDec = d3.format('.2f'),
        sortAscending = true,
        awayTeamSelect,
        homeTeamSelect,
        awayTeamFull,
        homeTeamFull,
        awayTeamIcon,
        homeTeamIcon;

    var Teams = 
    [
      {'abbr': 'NE', 'name': 'New England Patriots', 'imageLink': 'Icons/NE100.png'},
      {'abbr': 'MIA', 'name': 'Miami Dolphins', 'imageLink': 'Icons/MIA100.png'},
      {'abbr': 'BUF', 'name': 'Buffalo Bills', 'imageLink': 'Icons/BUF100.png'},
      {'abbr': 'NYJ', 'name': 'New York Jets', 'imageLink': 'Icons/NYJ100.png'},
      {'abbr': 'PIT', 'name': 'Pittsburgh Steelers', 'imageLink': 'Icons/PIT100.png'},
      {'abbr': 'BAL', 'name': 'Baltimore Ravens', 'imageLink': 'Icons/BAL100.png'},
      {'abbr': 'CIN', 'name': 'Cincinnati Bengals', 'imageLink': 'Icons/CIN100.png'},
      {'abbr': 'CLE', 'name': 'Cleveland Browns', 'imageLink': 'Icons/CLE100.png'},
      {'abbr': 'TEN', 'name': 'Tennessee Titans', 'imageLink': 'Icons/TEN100.png'},
      {'abbr': 'JAC', 'name': 'Jacksonville Jaguars', 'imageLink': 'Icons/JAC100.png'},
      {'abbr': 'HOU', 'name': 'Houston Texans', 'imageLink': 'Icons/HOU100.png'},
      {'abbr': 'IND', 'name': 'Indianapolis Colts', 'imageLink': 'Icons/IND100.png'},
      {'abbr': 'KC', 'name': 'Kansas City Chiefs', 'imageLink': 'Icons/KC100.png'},
      {'abbr': 'DEN', 'name': 'Denver Broncos', 'imageLink': 'Icons/DEN100.png'},
      {'abbr': 'OAK', 'name': 'Oakland Raiders', 'imageLink': 'Icons/OAK100.png'},
      {'abbr': 'SD', 'name': 'San Diego Chargers', 'imageLink': 'Icons/SD100.png'},
      {'abbr': 'LAC', 'name': 'Los Angeles Chargers', 'imageLink': 'Icons/LAC100.png'},
      {'abbr': 'PHI', 'name': 'Philadelphia Eagles', 'imageLink': 'Icons/PHI100.png'},
      {'abbr': 'WAS', 'name': 'Washington Redskins', 'imageLink': 'Icons/WAS100.png'},
      {'abbr': 'DAL', 'name': 'Dallas Cowboys', 'imageLink': 'Icons/DAL100.png'},
      {'abbr': 'NYG', 'name': 'New York Giants', 'imageLink': 'Icons/NYG100.png'},
      {'abbr': 'MIN', 'name': 'Minnesota Vikings', 'imageLink': 'Icons/MIN100.png'},
      {'abbr': 'GB', 'name': 'Green Bay Packers', 'imageLink': 'Icons/GB100.png'},
      {'abbr': 'DET', 'name': 'Detroit Lions', 'imageLink': 'Icons/DET100.png'},
      {'abbr': 'CHI', 'name': 'Chicago Bears', 'imageLink': 'Icons/CHI100.png'},
      {'abbr': 'NO', 'name': 'New Orleans Saints', 'imageLink': 'Icons/NO100.png'},
      {'abbr': 'CAR', 'name': 'Carolina Panthers', 'imageLink': 'Icons/CAR100.png'},
      {'abbr': 'ATL', 'name': 'Atlanta Falcons', 'imageLink': 'Icons/ATl100.png'},
      {'abbr': 'TB', 'name': 'Tampa Bay Buccaneers', 'imageLink': 'Icons/TB100.png'},
      {'abbr': 'SEA', 'name': 'Seattle Seahawks', 'imageLink': 'Icons/SEA100.png'},
      {'abbr': 'ARI', 'name': 'Arizona Cardinals', 'imageLink': 'Icons/ARI100.png'},
      {'abbr': 'LAR', 'name': 'Los Angeles Rams', 'imageLink': 'Icons/STL100.png'},
      {'abbr': 'STL', 'name': 'St. Louis Rams', 'imageLink': 'Icons/LAR100.png'},
      {'abbr': 'SF', 'name': 'San Francisco 49ers', 'imageLink': 'Icons/SF100.png'}
    ]
  //Dropdowns
    var gameSelect = d3.select('#game')
          .on('change', gameChange)

    var gameOptions = gameSelect
        .selectAll('option')
        .data(games).enter()
        .append('option')
          .text(function (d) { return d; });
      
    function gameChange() {
      gameSelection = d3.select('#game').property('value')
      
      for (var i = 0; i < gameIDs.length; i++) {
        if (gameIDs[i].indexOf(gameSelection) === 0){
          gameSelection = gameIDs[i];
          break;
        }
      }
      gameFilter();
      createSlider();
    };

    var weekSelect = d3.select('#week')
          .on('change',weekChange)
    
    var weekOptions = weekSelect
        .selectAll('option')
        .data(['Week',1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]).enter()
        .append('option')
          .text(function (d) { return d; });

    function weekChange() {
      weekSelection = d3.select('#week').property('value')

      gameSelection = 'Games';
      gameFilter();

      var index,
          kickoffs = gameFiltered.filter(function(d){
            return d.PlayType == 'Kickoff' && d.TimeSecs == '3600';
          });

      games = ['Games']; gameIDs = ['Games'];

      for (index = 0; index < kickoffs.length; ++index){
        var a = kickoffs[index].AwayTeam, h = kickoffs[index].HomeTeam, dt = kickoffs[index].DateofGame;
        
        var g = a + ' @ ' + h;
        if (!(games.indexOf(g) > 0)){
          games.push(g);
          gameIDs.push(g + ' ' + dt);
        }
      }
      d3.select('#game').selectAll('option').remove();

      gameOptions = gameSelect
        .selectAll('option')
        .data(games).enter()
        .append('option')
          .text(function (d) { return d; })

      createSlider();
    };
    
    

  // Slider
    
    function createSlider() {
      if (gameSelection != 'Games') { sx = 6.5; }
      else { sx = 70; }

      width = (document.body.clientWidth || document.documentElement.clientWidth || window.innerWidth) - margin.padLeft;
      height = 30;
      var translateLeft = 0; translateTop = margin.padTop;

      // if (width < 500) { 
      //   d3.select('#dropdowns').attr('align', 'center');
      //   translateLeft = 0;
      //   translateTop = 0;
      //   sx = 14.5;
      //   width = document.body.clientWidth || document.documentElement.clientWidth || window.innerWidth;
      //   // if (gameSelection == 'Games') { height = 60; }
      //   tickNum = 4;
      //   textX = width / 2;
      //   textY = 45;
      //   textAlign = 'middle';
      //   if (width < 250) { tickNum = 2; }
      // } else { d3.select('#dropdowns').attr('align', 'left'); }

      d3.select('#svg').selectAll('svg').remove();
      
      // Define the div for the tooltip

      var svg = d3.select('#svg')
          .append('svg')
          .attr('width', width)
          .attr('height', height)
          .attr('transform', 'translate(' + translateLeft  + ',' + translateTop + ')')

      var x = d3.scaleLinear()
          .domain([3600, -900])
          .range([0, width - sx - 13])
          .clamp(true);

      var slider = svg
        .append('g')
          // .attr('class', 'slider')
          .attr('transform', 'translate(' + sx + ', ' + sy + ')');

      slider.append('line')
          .attr('class', 'track')
          .attr('x1', x.range()[0])
          .attr('x2', x.range()[1])
        .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
          .attr('class', 'track-inset')
        .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
          .attr('class', 'track-overlay')
          .call(d3.drag()
              .on('start.interrupt', function() { slider.interrupt(); })
              .on('start drag', function() { clock(x.invert(d3.event.x)); })
              .on('end', function() {gameFilter();})
            );

      slider.insert('g', '.track-overlay')
          .attr('class', 'ticks')
          .attr('transform', 'translate(0,' + 20 + ')')
        .selectAll('text')
          .data(x.ticks(4))
        .enter().append('text')
          .attr('x', x)
          .attr('text-anchor', 'middle')
          .text(function(d) { return secsToClock(d); });
          
      var handle = slider.insert('ellipse', '.track-overlay')
          .attr('class', 'handle')
          .attr('rx', 13)
          .attr('ry', 8)
          .attr('cx', function() { 
            var cx
            if (startSlider) { cx = 0; }
            else { cx = x(secondSelection); }
            return cx;
          })
      
      var lace1 = slider.insert('line', '.track-toverlay')
          .attr('y1', -2)
          .attr('y2', 2)
          .attr('stroke-width', 1)
          .attr('stroke', 'white')
          .attr('x1', function() { 
            var x1
            if (startSlider) { x1 = -6; }
            else { x1 = x(secondSelection) - 6; }
            return x1;
          })
          .attr('x2', function() { 
            var x2
            if (startSlider) { x2 = -6; }
            else { x2 = x(secondSelection) - 6; }
            return x2;
          });

      var lace2 = slider.insert('line', '.track-toverlay')
          .attr('y1', -2)
          .attr('y2', 2)
          .attr('stroke-width', 1)
          .attr('stroke', 'white')
          .attr('x1', function() { 
            var x1
            if (startSlider) { x1 = -3; }
            else { x1 = x(secondSelection) - 3; }
            return x1;
          })
          .attr('x2', function() { 
            var x2
            if (startSlider) { x2 = -3; }
            else { x2 = x(secondSelection) - 3; }
            return x2;
          });

      var lace3 = slider.insert('line', '.track-toverlay')
          .attr('y1', -2)
          .attr('y2', 2)
          .attr('stroke-width', 1)
          .attr('stroke', 'white')
          .attr('x1', function() { 
            var x1
            if (startSlider) { x1 = 0; }
            else { x1 = x(secondSelection); }
            return x1;
          })
          .attr('x2', function() { 
            var x2
            if (startSlider) { x2 = 0; }
            else { x2 = x(secondSelection); }
            return x2;
          });;

      var lace4 = slider.insert('line', '.track-toverlay')
          .attr('y1', -2)
          .attr('y2', 2)
          .attr('stroke-width', 1)
          .attr('stroke', 'white')
          .attr('x1', function() { 
            var x1
            if (startSlider) { x1 = 3; }
            else { x1 = x(secondSelection) + 3; }
            return x1;
          })
          .attr('x2', function() { 
            var x2
            if (startSlider) { x2 = 3; }
            else { x2 = x(secondSelection) + 3; }
            return x2;
          });
      
      var lace5 = slider.insert('line', '.track-toverlay')
          .attr('y1', -2)
          .attr('y2', 2)
          .attr('stroke-width', 1)
          .attr('stroke', 'white')
          .attr('x1', function() { 
            var x1
            if (startSlider) { x1 = 6; }
            else { x1 = x(secondSelection) + 6; }
            return x1;
          })
          .attr('x2', function() { 
            var x2
            if (startSlider) { x2 = 6; }
            else { x2 = x(secondSelection) + 6; }
            return x2;
          });

      var laceC = slider.insert('line', '.track-toverlay')
          .attr('y1', 0)
          .attr('y2', 0)
          .attr('stroke-width', 1)
          .attr('stroke', 'white');
      
      var myText = svg.append('text')
        .attr('x', 1)
        .attr('y', 15)
        .attr('text-anchor', 'start');

      if (gameSelection == 'Games') {
        myText.text(myClock);
      }

      if (startSlider) {
        slider.transition() // Gratuitous intro!
            .duration(750)
            .tween('clock', function() {
              var i = d3.interpolate(0, 0);
              return function(t) { clock(i(t)); };
            });
        startSlider = false;
      }

      function clock(h) {
        handle.attr('cx', x(h)).text(function(h) { return h; });
        lace1.attr('x1', x(h) - 6).attr('x2', x(h) - 6);
        lace2.attr('x1', x(h) - 3).attr('x2', x(h) - 3);
        lace3.attr('x1', x(h)).attr('x2', x(h));
        lace4.attr('x1', x(h) + 3).attr('x2', x(h) + 3);
        lace5.attr('x1', x(h) + 6).attr('x2', x(h) + 6);
        laceC.attr('x1', x(h) - 6).attr('x2', x(h) + 6);

        secondSelection = h;
        myClock = secsToClock(formatInt(secondSelection));
        if (gameSelection == 'Games') { myText.text(myClock); }
      }
    }

    createSlider();
    // window.addEventListener("resize", );
    window.addEventListener("resize", createSlider);


    function secsToClock(sr){
      var q, m, s;

      if (sr > 2700) {
        q = 'Q1 ';
      } else if (sr > 1800) {
        q = 'Q2 ';
      } else if (sr > 900) {
        q = 'Q3 ';
      } else if (sr >= 0) {
        q = 'Q4 ';
      } else { q = 'OT '; sr = 900 + parseInt(sr); }

      if (sr % 900 == 0) {
          if (sr <= 0) {
            m = '00';
            s = '00';
          } else {
            m = '15';
            s = '00';
          }
      } else {
        m = Math.floor(sr % 900 / 60);
        s = (sr % 900) % 60;
      }
      if (s.toString().length == 1) { s = '0' + s; }

      return q + m + ':' + s; 
    }

  // Filter
    function gameFilter(){
      gameFiltered = data.filter(function(d){
        if( (d['GameID'] == gameSelection || gameSelection === 'Games') && (d['WeekNumber'] == weekSelection || weekSelection === 'Week') && d['TimeSecs'] >= secondSelection ){
          return d;
        }
      })
      // console.log(gameFiltered);
      refreshObj();
    }
    
  // refresh all data for displayed objects
    function refreshObj(){
      refreshGameOverview();

      d3.select('body').selectAll('table').remove();
      d3.select('body').selectAll('p').remove();

      refreshPass();
      refreshRush();
      refreshRec();
      refreshKick();
    }

  
  function refreshGameOverview() {
    // delete all objects
    d3.select('#score').remove();
    d3.select('#playDesc').remove();
    d3.select('#gameDiv').selectAll('svg').remove();
    var sA, sH; // scoreAway, scoreHome

    if (gameSelection != 'Games'){
  //Create score object
  // Score
      for (var i = gameFiltered.length - 1; i >= 0; i--) {
        homeTeamSelect = gameFiltered[i].HomeTeam;
        awayTeamSelect = gameFiltered[i].AwayTeam;

        if (gameFiltered[i].posteam == homeTeamSelect || gameFiltered[i].DefensiveTeam == awayTeamSelect) {
          sH = parseInt(gameFiltered[i].PosTeamScore);
          sA = parseInt(gameFiltered[i].DefTeamScore);
        } else if (gameFiltered[i].posteam == awayTeamSelect || gameFiltered[i].DefensiveTeam == homeTeamSelect) {
          sA = parseInt(gameFiltered[i].PosTeamScore);
          sH = parseInt(gameFiltered[i].DefTeamScore);
        }

        if (sA || sH) {
          if (parseInt(gameFiltered[i].pointValue) > 0) {
            if (gameFiltered[i].scoringTeam == homeTeamSelect) { sH = sH + parseInt(gameFiltered[i].pointValue); }
            else if (gameFiltered[i].scoringTeam == awayTeamSelect) { sA = sA + parseInt(gameFiltered[i].pointValue); }
          }
          break;
        }
      }
      // full team name
      for (var i = 0; i < Teams.length; i++){
        if (homeTeamSelect == Teams[i].abbr) {
          homeTeamFull = Teams[i].name;
          homeTeamIcon = Teams[i].imageLink;
        }
        if (awayTeamSelect == Teams[i].abbr) {
          awayTeamFull = Teams[i].name;
          awayTeamIcon = Teams[i].imageLink;
        }
      }

      myClock = gameFiltered[gameFiltered.length - 1].clock;
      var gameDiv = d3.select('#gameDiv')
        // .attr('id', 'score')
        .attr("width", '100%')
        .attr("height", 'auto')
        .style('background-color', 'white')
        .style('margin-bottom', '8px');
        // .append('text').text('hello world!').attr('x', 20).attr('y',20);
      
      var score = gameDiv.append('div').attr('id', 'score').attr('align', 'center');
      score.append('img')
        .attr('class', 'picture')
        .attr('src', awayTeamIcon)
        // .attr('x', 20).attr('y',20)
        .style('vertical-align', 'middle');
      score.append('text')
        .text(' ' + sA + '  ')
        .style('font-size', '40px')
        .style('font-weight', 'bold')
        .style('vertical-align', 'middle');
      score.append('text').text(myClock)
        .style('vertical-align', 'middle');
      score.append('text')
        .text('  ' + sH + ' ')
        .style('font-size', '40px')
        .style('font-weight', 'bold')
        .style('vertical-align', 'middle');
      score.append('img')
        .attr('class', 'picture')
        .attr('src', homeTeamIcon)
        // .attr('x', 20).attr('y',20)
        .style('vertical-align', 'middle')
        .style('align', 'right');
      
      var lastPlay = gameFiltered[gameFiltered.length - 1].playdesc;

      var playDesc = gameDiv.append('div').attr('id', 'playDesc').attr('align', 'center');
      playDesc.append('text').text(lastPlay).style('font-size','12px');

      // Create SVG
      var gameSvg = gameDiv.append('svg')
        .attr('id', 'gameDisplay')
        .attr('width', '100%')
        .attr('height', 300);

      // var rect = gameSvg.append('rect')
      //   .attr('width', '100%')
      //   .attr('height', '100%')
      //   .attr('fill', 'white');

      // Win Probability
      wp = gameFiltered.filter(function(d){ return d.Home_WP_post || d.Away_WP_post});

      // objSort(wp, 'TEAM', ['YDS', true]);
      
      gWP = gameSvg.append('g').attr('transform', 'translate(85, 20)'); 
      var lastSecs = gameFiltered[gameFiltered.length - 1].TimeSecs;
      var yHeight = 200;

      var x = d3.scaleLinear()
          .domain([3600, lastSecs])
          .range([0, width]);
      var y = d3.scaleLinear().rangeRound([yHeight,0]);
      var homeWP = d3.line()
          .x(function(d) { return x(parseInt(d.TimeSecs))})
          .y(function(d) { return y(parseFloat(d.Home_WP_post))})
      var awayWP = d3.line()
          .x(function(d) { return x(parseInt(d.TimeSecs))})
          .y(function(d) { return y(parseFloat(d.Away_WP_post))});

      var ticks = [3600]
      if (2250 > parseInt(wp[wp.length-1].TimeSecs)) { ticks.push(2700); } else { ticks.push(parseInt(wp[wp.length-1].TimeSecs)); }
      if (1350 > parseInt(wp[wp.length-1].TimeSecs)) { ticks.push(1800); } else { ticks.push(parseInt(wp[wp.length-1].TimeSecs)); }
      if (450 > parseInt(wp[wp.length-1].TimeSecs)) { ticks.push(900); } else { ticks.push(parseInt(wp[wp.length-1].TimeSecs)); }
      if (-150 > parseInt(wp[wp.length-1].TimeSecs) || parseInt(wp[wp.length-1].TimeSecs) < 15) { ticks.push(0); } 
      else { ticks.push(parseInt(wp[wp.length-1].TimeSecs)); }


      gWP.append('g')
        .attr('transform', 'translate(0,' + yHeight + ')')
          .call(d3.axisBottom(x)
                .tickValues(ticks)
                .tickFormat(function(d) { return secsToClock(d); }))
        .select('.domain')
          .remove();


      gWP.append('g')
          .call(d3.axisLeft(y))
        .append('text')
          .attr('fill', '#000')
          .attr('transform', 'rotate(-90)')
          .attr('y', 6)
          .attr('dy', '0.71em')
          .attr('text-anchor', 'end')
          .text('Win Prob');

      gWP.append('path')
        .datum(wp)
        .attr('fill', 'none')
        .attr('stroke', 'steelblue')
        .attr('stroke-linejoin', 'round')
        .attr('stroke-linecap', 'round')
        .attr('stroke-width', 1.5)
        .attr('d', homeWP);
      
      gWP.append('path')
        .datum(wp)
        .attr('fill', 'none')
        .attr('stroke', 'orange')
        .attr('stroke-linejoin', 'round')
        .attr('stroke-linecap', 'round')
        .attr('stroke-width', 1.5)
        .attr('d', awayWP);
   
    }
    // console.log(gameFiltered);
    // console.log(homeTeamSelect + ': ' + sH + ' || ' + awayTeamSelect + ': ' + sA);
  }

  // Team Comparisons

  // Tables
    var passTbl, rushTbl, recTbl, kickTbl;

    function refreshPass(){
      passTbl = [];
      passers = d3.nest()
          .key(function(d) { return d.Passer })
          .entries(gameFiltered.filter(function(d){ return (d.PlayType == 'Pass' || d.PlayType == 'Sack') && d.Passer !== '' && d.Passer !== 'NA'}));

      var team, attempts, completions, passYards, passTD, interceptions, sacks, sackYards, qbHits;

      for (var index = 0; index < passers.length; ++index){
        // console.log(passers[index].key);
        // console.log(passers[index].values[0]);
        attempts = 0; completions = 0; passYards = 0; passTD = 0; interceptions = 0; sacks = 0; sackYards = 0; qbHits = 0;
        for (var index1 = 0; index1 < passers[index].values.length; ++index1){
          //console.log(passers[index].values[index1].YardsGained);
          if (index1 == 0) { team = passers[index].values[index1].posteam; }
          if (passers[index].values[index1].PlayType == 'Pass') {
            attempts++;
            completions = completions + parseInt(passers[index].values[index1].Reception);
            passYards = passYards + parseInt(passers[index].values[index1].YardsGained);
            interceptions = interceptions + parseInt(passers[index].values[index1].InterceptionThrown);
            if (passers[index].values[index1].posteam == passers[index].values[index1].scoringTeam) {
              passTD = passTD + parseInt(passers[index].values[index1].Touchdown);
            }
          }
          if (passers[index].values[index1].PlayType == 'Sack') {
            sacks = sacks + parseInt(passers[index].values[index1].Sack);
            sackYards = sackYards + (parseInt(passers[index].values[index1].YardsGained));
          }
          qbHits = qbHits + parseInt(passers[index].values[index1].QBHit);
        }

        // Add entry to passTbl
        passTbl.push({
          'NAME': passers[index].key, // Passer
          'TEAM': team,
          // any variables summed in nested loop
          // 'Complete': completions,
          // 'Attempts': attempts,
          'C / ATT': completions + ' / ' + attempts,
          'YDS': passYards,
          'TD': passTD,
          'INT': interceptions,
          'QB HIT': qbHits,
          'SACKS': sacks,
          'SACK YDS': sackYards
        });
      }
      objSort(passTbl, 'TEAM', ['YDS', true]);
      d3.select('#pass').selectAll('text').remove();
      d3.select('#pass').remove();
      d3.select('body').append('div').attr('id', 'pass').attr('class', 'clearfix');

      if (passTbl.length > 0){

        if (gameSelection != 'Games') {
          d3.select('#homeTeamPass').remove();
          d3.select('#awayTeamPass').remove();

          d3.select('#pass')
            .append('div')
              .attr('id', 'awayTeamPass')
              .style('float', 'left')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', awayTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#awayTeamPass')
            .append('text')
              .text(' ' + awayTeamFull + ' Passing ')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');

          d3.select('#pass')
            .append('div')
              .attr('id', 'homeTeamPass')
              .style('float', 'right')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', homeTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#homeTeamPass')
            .append('text')
              .text(' ' + homeTeamFull + ' Passing')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');

          tabulate('#awayTeamPass', passTbl.filter(function(d){ return d.TEAM == awayTeamSelect }), ['NAME', 'C / ATT', 'YDS', 'TD', 'INT', 'QB HIT', 'SACKS', 'SACK YDS']);
          tabulate('#homeTeamPass', passTbl.filter(function(d){ return d.TEAM == homeTeamSelect }), ['NAME', 'C / ATT', 'YDS', 'TD', 'INT', 'QB HIT', 'SACKS', 'SACK YDS']);

        } else {
          if (weekSelection == 'Week') {
            d3.select('#pass')
              .style('background-color', 'white')
              .append('text')
                .text('Season Passing')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          } else {
            d3.select('#pass')
              .style('background-color', 'white')
              .append('text')
                .text('Week ' + weekSelection + ' Passing')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
                // .on('click', hideDiv('tblpass'));
          }

          tabulate('#pass', passTbl, ['NAME', 'TEAM', 'C / ATT', 'YDS', 'TD', 'INT', 'QB HIT', 'SACKS', 'SACK YDS']);
        }
      }
    }

    function refreshRush(){
      rushTbl = [];
      rushers = d3.nest()
          .key(function(d) { return d.Rusher })
          .entries(gameFiltered.filter(function(d){ return (d.PlayType == 'Run' || d.PlayType == 'Sack') && d.Rusher !== '' && d.Rusher !== 'NA' }));

      var team, attempts, rushYards, ypc, rushTD, fumbles, fumblesLost, long;

      for (var index = 0; index < rushers.length; ++index){
        attempts = 0; rushYards = 0; ypc = 0; rushTD = 0;  fumbles = 0; fumblesLost = 0; long = 0;
        for (var index1 = 0; index1 < rushers[index].values.length; ++index1){
          if (index1 == 0) { team = rushers[index].values[index1].posteam; }
          if (rushers[index].values[index1].PlayType == 'Run') {
            attempts++;
            rushYards = rushYards + parseInt(rushers[index].values[index1].YardsGained);
            if (rushers[index].values[index1].posteam == rushers[index].values[index1].scoringTeam) {
              rushTD = rushTD + parseInt(rushers[index].values[index1].Touchdown);
            }
            fumbles = fumbles + parseInt(rushers[index].values[index1].Fumble);
            if (rushers[index].values[index1].Fumble == '1' && rushers[index].values[index1].RecFumbTeam != rushers[index].values[index1].posteam) { fumblesLost++; }
            if (parseInt(rushers[index].values[index1].YardsGained) > long) { long = parseInt(rushers[index].values[index1].YardsGained); }
          }
          if (rushers[index].values[index1].PlayType == 'Sack') {
            fumbles = fumbles + parseInt(rushers[index].values[index1].Fumble);
            if (rushers[index].values[index1].Fumble == '1' && rushers[index].values[index1].RecFumbTeam != rushers[index].values[index1].posteam) { fumblesLost++; }
          }
        }
        if (attempts > 0){
          ypc = formatDec(rushYards * 1.00 / attempts);
        } else { ypc = '-'; }
        

        // Add entry to passTbl
        rushTbl.push({
          'NAME': rushers[index].key, // Passer
          'TEAM': team,
          // any variables summed in nested loop
          'ATT': attempts,
          'YDS': rushYards,
          'AVG': ypc,
          'TD': rushTD,
          'FUM': fumbles,
          'LOST': fumblesLost,
          'LONG': long
        });
      }
      objSort(rushTbl, 'TEAM', ['ATT', true]);
      d3.select('#rush').selectAll('text').remove();
      d3.select('#rush').remove();
      d3.select('body').append('div').attr('id', 'rush').attr('class', 'clearfix');
      
      if (rushTbl.length > 0 ) {

        if (gameSelection != 'Games') {
          d3.select('#homeTeamRush').remove();
          d3.select('#awayTeamRush').remove();

          d3.select('#rush')
            .append('div')
              .attr('id', 'awayTeamRush')
              .style('float', 'left')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', awayTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#awayTeamRush')
            .append('text')
            .text(' ' + awayTeamFull + ' Rushing')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');

          d3.select('#rush')
            .append('div')
              .attr('id', 'homeTeamRush')
              .style('float', 'right')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', homeTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#homeTeamRush')
            .append('text')
              .text(' ' + homeTeamFull + ' Rushing')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');
            
          tabulate('#awayTeamRush', rushTbl.filter(function(d){ return d.TEAM == awayTeamSelect }), ['NAME', 'ATT', 'YDS', 'AVG', 'TD', 'LONG', 'FUM', 'LOST']);
          tabulate('#homeTeamRush', rushTbl.filter(function(d){ return d.TEAM == homeTeamSelect }), ['NAME', 'ATT', 'YDS', 'AVG', 'TD', 'LONG', 'FUM', 'LOST']);
        } else {
          if (weekSelection == 'Week') {
            d3.select('#rush')
              .style('background-color', 'white')
              .append('text')
                .text('Season Rushing')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          } else {
            d3.select('#rush')
              .style('background-color', 'white')
              .append('text')
                .text('Week ' + weekSelection + ' Rushing')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          }

          tabulate('#rush', rushTbl, ['NAME', 'TEAM', 'ATT', 'YDS', 'AVG', 'TD', 'LONG', 'FUM', 'LOST']);
        }
      }
    }

    function refreshRec(){
      recTbl = [];
      receivers = d3.nest()
          .key(function(d) { return d.Receiver })
          .entries(gameFiltered.filter(function(d){ return (d.PlayType == 'Pass') && d.Receiver !== '' && d.Receiver !== 'NA' }));

      var team, targets, receptions, recYards, ypc, recTD, long, yac;

      for (var index = 0; index < receivers.length; ++index){
        // console.log(receivers[index].key);
        // console.log(receivers[index].values[0]);
        targets = 0; receptions = 0; recYards = 0; ypc = 0; recTD = 0; long = 0, yac = 0;
        for (var index1 = 0; index1 < receivers[index].values.length; ++index1){
          //console.log(receivers[index].values[index1].YardsGained);
          if (index1 == 0) { team = receivers[index].values[index1].posteam; }
          targets++;
          receptions = receptions + parseInt(receivers[index].values[index1].Reception);
          recYards = recYards + parseInt(receivers[index].values[index1].YardsGained);
          yac = yac + parseInt(receivers[index].values[index1].YardsAfterCatch);
          if (receivers[index].values[index1].posteam == receivers[index].values[index1].scoringTeam) {
            recTD = recTD + parseInt(receivers[index].values[index1].Touchdown);
          }
          if (parseInt(receivers[index].values[index1].YardsGained) > long) { long = parseInt(receivers[index].values[index1].YardsGained); }
        }
        if (receptions > 0){
          ypc = formatDec(recYards * 1.00 / receptions);
        } else { ypc = '-'; }
        
        // Add entry to passTbl
        recTbl.push({
          'NAME': receivers[index].key, // Passer
          'TEAM': team,
          // any variables summed in nested loop
          'TAR': targets,
          'REC': receptions,
          'YDS': recYards,
          'AVG': ypc, 
          'TD': recTD,
          'YAC': yac,
          'LONG': long
        });
      }
      objSort(recTbl, 'TEAM', ['REC', true]);
      d3.select('#rec').selectAll('text').remove();
      d3.select('#rec').remove();
      d3.select('body').append('div').attr('id', 'rec').attr('class', 'clearfix');
      
      if (recTbl.length > 0 ) {

        if (gameSelection != 'Games') {
          d3.select('#homeTeamRec').remove();
          d3.select('#awayTeamRec').remove();

          d3.select('#rec')
            .append('div')
              .attr('id', 'awayTeamRec')
              .style('float', 'left')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', awayTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#awayTeamRec')
            .append('text')
             .text(' ' + awayTeamFull + ' Receiving')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');

          d3.select('#rec')
            .append('div')
              .attr('id', 'homeTeamRec')
              .style('float', 'right')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', homeTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#homeTeamRec')
            .append('text')
              .text(' ' + homeTeamFull + ' Receiving')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');
            
          tabulate('#awayTeamRec', recTbl.filter(function(d){ return d.TEAM == awayTeamSelect }), ['NAME', 'TAR', 'REC', 'YDS', 'AVG', 'TD', 'YAC', 'LONG']);
          tabulate('#homeTeamRec', recTbl.filter(function(d){ return d.TEAM == homeTeamSelect }), ['NAME', 'TAR', 'REC', 'YDS', 'AVG', 'TD', 'YAC', 'LONG']);
        } else {
          if (weekSelection == 'Week') {
            d3.select('#rec')
              .style('background-color', 'white')
              .append('text')
                .text('Season Receiving')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          } else {
            d3.select('#rec')
              .style('background-color', 'white')
              .append('text')
                .text('Week ' + weekSelection + ' Receiving')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          }

          tabulate('#rec', recTbl, ['NAME', 'TEAM', 'TAR', 'REC', 'YDS', 'AVG', 'TD', 'YAC', 'LONG']);
        }
      }
      // d3.select('body').append('p');
    }

///*
    function refreshKick(){
      kickTbl = [];
      kickers = d3.nest()
          .key(function(d) { return d.Kicker })
          .entries(gameFiltered.filter(function(d){ return (d.PlayType == 'Field Goal' || d.PlayType == 'Extra Point') && d.kicker !== '' && d.kicker !== 'NA' }));
      var team, fga, fgm, xpa, xpm, long;

      for (var index = 0; index < kickers.length; ++index){
        team = 0; fga = 0; fgm = 0; xpa = 0; xpm = 0; long = 0;
        for (var index1 = 0; index1 < kickers[index].values.length; ++index1){
          //console.log(kickers[index].values[index1].YardsGained);
          if (index1 == 0) { team = kickers[index].values[index1].posteam; }
            if (kickers[index].values[index1].PlayType == 'Field Goal') {
              fga++;
              if (kickers[index].values[index1].FieldGoalResult == 'Good') {
                fgm++;
                if (parseInt(kickers[index].values[index1].FieldGoalDistance) > long) { long = parseInt(kickers[index].values[index1].FieldGoalDistance); }
              }
            }
            if (kickers[index].values[index1].PlayType == 'Extra Point') {
              fga++;
              if (kickers[index].values[index1].FieldGoalResult == 'Made') {
                fgm++;
              }
            }
          }
        
        // Add entry to passTbl
        kickTbl.push({
          'NAME': kickers[index].key, // Passer
          'TEAM': team,
          // any variables summed in nested loop
          'FGA': fga,
          'FGM': fgm,
          'XPA': xpa,
          'XPM': xpm,
          'LONG': long
        });
      }

      objSort(kickTbl, 'TEAM', ['kick', true]);
      d3.select('#kick').selectAll('text').remove();
      d3.select('#kick').remove();
      d3.select('body').append('div').attr('id', 'kick').attr('class', 'clearfix');
      
      if (kickTbl.length > 0 ) {

        if (gameSelection != 'Games') {
          d3.select('#homeTeamkick').remove();
          d3.select('#awayTeamkick').remove();

          d3.select('#kick')
            .append('div')
              .attr('id', 'awayTeamkick')
              .style('float', 'left')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', awayTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#awayTeamkick')
            .append('text')
             .text(' ' + awayTeamFull + ' Kicking')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');

          d3.select('#kick')
            .append('div')
              .attr('id', 'homeTeamkick')
              .style('float', 'right')
              .style('width', 49.75+'%')
              .style('overflow', 'auto')
              .style('background-color', 'white')
            .append('img')
              .attr('class', 'picture')
              .attr('src', homeTeamIcon.replace('100.png', '20.png'))
              .style('vertical-align', 'middle');
          d3.select('#homeTeamkick')
            .append('text')
              .text(' ' + homeTeamFull + ' Kicking')
              .style('font-weight', 'bold')
              .style('vertical-align', 'middle');
            
          tabulate('#awayTeamkick', kickTbl.filter(function(d){ return d.TEAM == awayTeamSelect }), ['NAME', 'FGA', 'FGM', 'XPA', 'XPM', 'LONG']);
          tabulate('#homeTeamkick', kickTbl.filter(function(d){ return d.TEAM == homeTeamSelect }), ['NAME', 'FGA', 'FGM', 'XPA', 'XPM', 'LONG']);
        } else {
          if (weekSelection == 'Week') {
            d3.select('#kick')
              .style('background-color', 'white')
              .append('text')
                .text('Season Kicking')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          } else {
            d3.select('#kick')
              .style('background-color', 'white')
              .append('text')
                .text('Week ' + weekSelection + ' Kicking')
                .style('font-weight', 'bold')
                .style('vertical-align', 'middle');
          }

          tabulate('#kick', kickTbl, ['NAME', 'TEAM', 'FGA', 'FGM', 'XPA', 'XPM', 'LONG']);
        }
      }
      // d3.select('body').append('p');
    }
//*/

    var tabulate = function (divSelect,data,columns) {
      var table = d3.select(divSelect).append('table').attr('id', 'tbl' + divSelect.replace('#',''));
      //var table = body.append('table')

      var headers = table.append('thead').append('tr')
        .selectAll('th')
          .data(columns).enter()
        .append('th')
          .text(function (d) { return d })
          .style('font-size', '12px')
        .on('click', function (d) {
          headers.attr('class', 'header');
            
            if (sortAscending) {
              rows.sort(function(a, b) { return  a[d] - b[d]; });
              sortAscending = false;
              this.className = 'aes';
            } else {
            rows.sort(function(a, b) { return b[d] - a[d]; });
            sortAscending = true;
            this.className = 'des';
            }
          });

      var rows = table.append('tbody').selectAll('tr')
        .data(data)
        .enter()
        .append('tr')

      var cells = rows.selectAll('td')
        .data(function(row) {
          return columns.map(function (column) { return { column: column, value: row[column] } })
        })
        .enter()
        .append('td')
          // .text(function (d) { return d.value })
          .attr('data-th', function (d) { return d.name; })
          .text(function (d) { return d.value; })
          .style('font-size', '12px');
        
      return table;
    }

  // Multidimensional sort. THANK YOU STACKOVERFLOW!
    function objSort() {
      var args = arguments,
          array = args[0],
          case_sensitive, keys_length, key, desc, a, b, i;

      if (typeof arguments[arguments.length - 1] === 'boolean') {
          case_sensitive = arguments[arguments.length - 1];
          keys_length = arguments.length - 1;
      } else {
          case_sensitive = false;
          keys_length = arguments.length;
      }

      return array.sort(function (obj1, obj2) {
          for (i = 1; i < keys_length; i++) {
              key = args[i];
              if (typeof key !== 'string') {
                  desc = key[1];
                  key = key[0];
                  a = obj1[args[i][0]];
                  b = obj2[args[i][0]];
              } else {
                  desc = false;
                  a = obj1[args[i]];
                  b = obj2[args[i]];
              }

              if (case_sensitive === false && typeof a === 'string') {
                  a = a.toLowerCase();
                  b = b.toLowerCase();
              }

              if (! desc) {
                  if (a < b) return -1;
                  if (a > b) return 1;
              } else {
                  if (a > b) return -1;
                  if (a < b) return 1;
              }
          }
          return 0;
      });
    } //end of objSort() function

    /* function hideDiv(divName) {
      var x = document.getElementById(divName);
      if (x.style.display === "none") {
          x.style.display = "block";
      } else {
          x.style.display = "none";
      }
    } */
  })

  </script>
</body>